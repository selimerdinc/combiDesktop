name: Deploy Kombi Master Pro

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/kombi-app
            
            echo "ğŸ’¾ Backing up database before deployment..."
            mkdir -p ~/backups
            # Docker volume'daki DB'yi manuel bir klasore kopyala
            sudo cp /var/lib/docker/volumes/kombi-app_kombi-db/_data/kombi_master_v2.db ~/backups/kombi_pre_deploy_$(date +%Y%m%d_%H%M).db || true
            
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            echo "ğŸ” Updating .env file..."
            echo "${{ secrets.ENV_FILE }}" > .env
            
            echo "ğŸ³ Restarting containers (Clean Rebuild)..."
            # down command avoids the ContainerConfig bug in older docker-compose versions
            docker-compose down || true
            docker-compose up -d --build
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
